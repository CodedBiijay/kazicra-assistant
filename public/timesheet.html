<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KaziCRA - Professional Timesheet</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

        body {
            font-family: 'Inter', sans-serif;
        }
    </style>
</head>

<body class="bg-slate-50 text-slate-900 pb-20">

    <!-- Header -->
    <header class="bg-indigo-700 text-white p-4 shadow-md sticky top-0 z-50">
        <div class="max-w-4xl mx-auto flex justify-between items-center">
            <div>
                <h1 class="text-xl font-bold">My Timecard</h1>
                <p class="text-xs text-indigo-200">CO003 - Senior CRA</p>
            </div>
            <div
                class="h-10 w-10 rounded-full bg-indigo-500 flex items-center justify-center font-bold text-sm ring-2 ring-indigo-400">
                DO</div>
        </div>
    </header>

    <main class="max-w-4xl mx-auto p-4 space-y-6">

        <!-- Entry Form -->
        <section class="bg-white rounded-lg shadow border border-slate-200 p-5 relative">
            <h2
                class="text-sm font-bold text-slate-500 uppercase tracking-wider mb-4 border-b border-slate-100 pb-2 flex justify-between">
                <span id="formTitle">New Time Block</span>
                <button id="cancelEditBtn" class="hidden text-xs text-red-500 hover:text-red-700 font-medium">Cancel
                    Edit</button>
            </h2>
            <form id="timeForm" class="space-y-4">
                <input type="hidden" name="entryId" id="entryId">

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Project Link</label>
                        <select name="projectId" id="projectSelect"
                            class="w-full rounded border-slate-300 p-2 text-sm bg-white focus:ring-2 focus:ring-indigo-500 focus:outline-none"
                            required>
                            <option value="">Select Study...</option>
                            <option value="NEW" class="font-bold text-indigo-600 bg-indigo-50">+ Add New Study...
                            </option>
                            <optgroup label="Active Studies" id="projectOptions">
                                <!-- Dynamic -->
                            </optgroup>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Site (Optional)</label>
                        <select name="siteId" id="siteSelect"
                            class="w-full rounded border-slate-300 p-2 text-sm bg-white focus:ring-2 focus:ring-indigo-500 focus:outline-none">
                            <option value="">None / General</option>
                            <option value="NEW" class="font-bold text-indigo-600 bg-indigo-50">+ Add New Site...
                            </option>
                            <optgroup label="Site Directory" id="siteOptions">
                                <!-- Dynamic -->
                            </optgroup>
                        </select>
                    </div>
                </div>

                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div class="col-span-2">
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Activity</label>
                        <select name="activityType"
                            class="w-full rounded border-slate-300 p-2 text-sm bg-white focus:ring-2 focus:ring-indigo-500 focus:outline-none"
                            required>
                            <option value="Monitoring (Onsite)">Monitoring (Onsite)</option>
                            <option value="SOP Reading">SOP Reading</option>
                            <option value="Visit Conduct">Visit Conduct</option>
                            <option value="Visit Preparation">Visit Preparation</option>
                            <option value="Visit Report Writing">Visit Report Writing</option>
                            <option value="Project Specific Training">Project Specific Training</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Hours</label>
                        <input type="number" name="hours" step="0.25" placeholder="0.00"
                            class="w-full rounded border-slate-300 p-2 text-sm focus:ring-2 focus:ring-indigo-500 focus:outline-none"
                            required>
                    </div>
                    <div class="flex items-end pb-2">
                        <label class="flex items-center gap-2 cursor-pointer select-none">
                            <input type="checkbox" id="winToggle"
                                class="w-4 h-4 text-indigo-600 rounded border-gray-300 focus:ring-indigo-500">
                            <span class="text-sm font-medium text-slate-700">Mark as Win?</span>
                        </label>
                    </div>
                </div>

                <div id="winFields" class="hidden animate-fade-in bg-amber-50 p-4 rounded border border-amber-200 mt-2">
                    <div class="mb-3">
                        <label class="block text-xs font-bold text-amber-700 uppercase mb-1">Win Title</label>
                        <input type="text" name="winTitle"
                            class="w-full rounded border-amber-200 p-2 text-sm focus:ring-2 focus:ring-amber-500 focus:border-amber-500 outline-none">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-amber-700 uppercase mb-1">Impact (The "So
                            What?")</label>
                        <textarea name="winImpact" rows="2"
                            class="w-full rounded border-amber-200 p-2 text-sm focus:ring-2 focus:ring-amber-500 focus:border-amber-500 outline-none"></textarea>
                    </div>
                </div>

                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Notes / Description</label>
                    <input type="text" name="notes" placeholder="Details..."
                        class="w-full rounded border-slate-300 p-2 text-sm focus:ring-2 focus:ring-indigo-500 focus:outline-none"
                        required>
                    <p id="phiWarning" class="hidden text-xs text-red-600 mt-1 font-bold">⚠️ Warning: Potential PHI
                        detected. Do not enter patient initials or IDs.</p>
                </div>

                <button type="submit" id="submitBtn"
                    class="bg-indigo-600 hover:bg-indigo-700 text-white font-medium py-2 px-4 rounded shadow-sm text-sm transition-colors flex items-center gap-2 w-full md:w-auto justify-center">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                    </svg>
                    <span>Add Entry</span>
                </button>
            </form>
        </section>

        <!-- Timesheet Grid -->
        <section class="bg-white rounded-lg shadow border border-slate-200 overflow-hidden">
            <div class="bg-slate-100 px-4 py-2 border-b border-slate-200 flex justify-between items-center">
                <h3 class="text-sm font-bold text-slate-700">Current Grid</h3>
                <span class="text-xs font-mono bg-white border border-slate-300 px-2 py-0.5 rounded text-slate-600">Week
                    Total: <span id="weekTotal">0.00</span></span>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-sm text-left">
                    <thead class="bg-slate-50 text-slate-500 font-semibold border-b border-slate-200">
                        <tr>
                            <th class="px-4 py-3 w-10"></th> <!-- Status Icon -->
                            <th class="px-4 py-3">Date</th>
                            <th class="px-4 py-3">Project</th>
                            <th class="px-4 py-3">Site</th>
                            <th class="px-4 py-3">Activity</th>
                            <th class="px-4 py-3 text-right">Hours</th>
                            <th class="px-4 py-3 w-20 text-center">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="timesheetBody" class="divide-y divide-slate-100">
                        <!-- Populated JS -->
                    </tbody>
                </table>
            </div>
        </section>

    </main>

    <!-- Bottom Nav -->
    <nav class="fixed bottom-0 left-0 right-0 bg-white border-t border-slate-200 pb-safe z-50">
        <div class="flex justify-around items-center h-16 max-w-2xl mx-auto">
            <a href="/"
                class="flex flex-col items-center justify-center w-full h-full text-slate-400 hover:text-slate-600">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                <span class="text-[10px] font-medium mt-1">Wins</span>
            </a>
            <a href="/sites.html"
                class="flex flex-col items-center justify-center w-full h-full text-slate-400 hover:text-slate-600">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4">
                    </path>
                </svg>
                <span class="text-[10px] font-medium mt-1">Sites</span>
            </a>
            <a href="/tools"
                class="flex flex-col items-center justify-center w-full h-full text-slate-400 hover:text-slate-600">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M19.428 15.428a2 2 0 00-1.022-.547l-2.384-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z">
                    </path>
                </svg>
                <span class="text-[10px] font-medium mt-1">Tools</span>
            </a>
            <!-- Site Dir / Timecard -->
            <a href="/timesheet.html" class="flex flex-col items-center justify-center w-full h-full text-indigo-600">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                <span class="text-[10px] font-medium mt-1">Timecard</span>
            </a>
        </div>
    </nav>

    <script>
        // PHI Guardrails
        const phiPatterns = [/\b[A-Z]{2,3}-\d{3,}\b/, /\b(Patient|Subject)\s+#?\d+/i];
        document.querySelector('input[name="notes"]').addEventListener('input', (e) => {
            const val = e.target.value;
            const warningInfo = document.getElementById('phiWarning');
            const hasPhi = phiPatterns.some(p => p.test(val));
            if (hasPhi) {
                warningInfo.classList.remove('hidden');
                e.target.classList.add('border-red-500', 'focus:ring-red-500');
            } else {
                warningInfo.classList.add('hidden');
                e.target.classList.remove('border-red-500', 'focus:ring-red-500');
            }
        });

        // Win Toggle logic
        const winToggle = document.getElementById('winToggle');
        const winFields = document.getElementById('winFields');
        winToggle.addEventListener('change', (e) => {
            if (e.target.checked) {
                winFields.classList.remove('hidden');
                document.querySelector('[name="winTitle"]').setAttribute('required', 'true');
                document.querySelector('[name="winImpact"]').setAttribute('required', 'true');
            } else {
                winFields.classList.add('hidden');
                document.querySelector('[name="winTitle"]').removeAttribute('required');
                document.querySelector('[name="winImpact"]').removeAttribute('required');
            }
        });

        // Data Loaders
        let allProjects = [];
        let allSites = [];
        let allEntries = [];

        async function init() {
            await Promise.all([loadProjects(), loadSites(), loadTimesheets()]);
        }

        async function loadProjects() {
            try {
                const res = await fetch('/api/projects');
                allProjects = await res.json();
                renderProjectOptions();
            } catch (e) { console.error(e); }
        }

        function renderProjectOptions() {
            const group = document.getElementById('projectOptions');
            group.innerHTML = '';
            allProjects.forEach(p => {
                const opt = document.createElement('option');
                opt.value = p.code; // Use code as ID for now as per schema logic
                opt.textContent = `${p.code} - ${p.name}`;
                group.appendChild(opt);
            });
        }

        async function loadSites() {
            try {
                const res = await fetch('/api/sites');
                allSites = await res.json();
                renderSiteOptions();
            } catch (e) { console.error(e); }
        }

        function renderSiteOptions() {
            const group = document.getElementById('siteOptions');
            group.innerHTML = '';
            allSites.forEach(s => {
                const opt = document.createElement('option');
                opt.value = s.siteId;
                opt.textContent = `${s.siteId} - ${s.name}`;
                group.appendChild(opt);
            });
        }

        async function loadTimesheets() {
            try {
                const res = await fetch('/api/timesheets');
                allEntries = await res.json();
                renderGrid(allEntries);
            } catch (e) { console.error(e); }
        }

        function renderGrid(entries) {
            const tbody = document.getElementById('timesheetBody');
            tbody.innerHTML = '';
            let total = 0;

            if (entries.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="p-4 text-center text-slate-400 text-xs">No entries yet.</td></tr>';
                document.getElementById('weekTotal').textContent = '0.00';
                return;
            }

            entries.forEach(entry => {
                total += entry.hours;
                const tr = document.createElement('tr');
                tr.className = 'hover:bg-slate-50 transition-colors group';

                const isWin = !!entry.linkedAchievementId;
                if (isWin) tr.classList.add('bg-amber-50/50');

                const iconCell = isWin
                    ? `<span title="Win/Achievement" class="text-amber-500">★</span>`
                    : `<span class="text-slate-300 text-xs">●</span>`;

                tr.innerHTML = `
                    <td class="px-4 py-3 text-center">${iconCell}</td>
                    <td class="px-4 py-3 text-slate-600 font-medium whitespace-nowrap">${new Date(entry.date).toLocaleDateString()}</td>
                    <td class="px-4 py-3 text-slate-800 font-bold text-xs uppercase tracking-wide">${entry.projectId}</td>
                    <td class="px-4 py-3 text-slate-600 text-xs">${entry.siteId || '<span class="text-slate-300 italic">None</span>'}</td>
                    <td class="px-4 py-3 text-slate-600">
                        <span class="block">${entry.activityType}</span>
                        <span class="text-[10px] text-slate-400 block truncate max-w-[150px]">${entry.notes}</span>
                    </td>
                    <td class="px-4 py-3 text-right font-mono text-slate-700">${entry.hours.toFixed(2)}</td>
                    <td class="px-4 py-3 text-center">
                        <div class="flex items-center justify-center gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                            <button onclick="editEntry('${entry.id}')" class="text-slate-400 hover:text-indigo-600" title="Edit">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path></svg>
                            </button>
                            <button onclick="deleteEntry('${entry.id}')" class="text-slate-400 hover:text-red-600" title="Delete">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                            </button>
                        </div>
                    </td>
                `;
                tbody.appendChild(tr);
            });

            document.getElementById('weekTotal').textContent = total.toFixed(2);
        }

        // --- Dynamic Dropdown Handlers ---
        document.getElementById('projectSelect').addEventListener('change', async (e) => {
            if (e.target.value === 'NEW') {
                const code = prompt("Enter Study Code (e.g., CRA-2026):");
                if (!code) { e.target.value = ""; return; }
                const name = prompt("Enter Study Name (e.g., Phase 3 Oncology):");
                if (!name) { e.target.value = ""; return; }

                try {
                    const res = await fetch('/api/projects', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ code, name })
                    });
                    if (res.ok) {
                        await loadProjects();
                        e.target.value = code;
                    } else { alert("Failed to add project"); e.target.value = ""; }
                } catch (err) { console.error(err); e.target.value = ""; }
            }
        });

        document.getElementById('siteSelect').addEventListener('change', async (e) => {
            if (e.target.value === 'NEW') {
                const siteId = prompt("Enter Site ID (e.g., 101):");
                if (!siteId) { e.target.value = ""; return; }
                const name = prompt("Enter Site Name:");
                if (!name) { e.target.value = ""; return; }
                const location = prompt("Enter Location (City/State):") || "Unknown";

                try {
                    const res = await fetch('/api/sites', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ siteId, name, location, notes: "Added via Timesheet" })
                    });
                    if (res.ok) {
                        await loadSites();
                        e.target.value = siteId;
                    } else { alert("Failed to add site"); e.target.value = ""; }
                } catch (err) { console.error(err); e.target.value = ""; }
            }
        });

        // --- CRUD Logic ---

        // DELETE
        window.deleteEntry = async (id) => {
            if (!confirm("Are you sure you want to delete this entry?")) return;
            try {
                const res = await fetch(`/api/timesheets/${id}`, { method: 'DELETE' });
                if (res.ok) loadTimesheets();
            } catch (e) { console.error(e); }
        };

        // EDIT
        window.editEntry = (id) => {
            const entry = allEntries.find(e => e.id === id);
            if (!entry) return;

            // Populate Form
            document.getElementById('entryId').value = entry.id;
            document.querySelector('[name="projectId"]').value = entry.projectId;
            document.querySelector('[name="siteId"]').value = entry.siteId || "";
            document.querySelector('[name="activityType"]').value = entry.activityType;
            document.querySelector('[name="hours"]').value = entry.hours;
            document.querySelector('[name="notes"]').value = entry.notes;

            // GUI Updates
            document.getElementById('formTitle').textContent = "Edit Time Block";
            document.getElementById('submitBtn').innerHTML = `<span>Update Entry</span>`;
            document.getElementById('submitBtn').classList.replace('bg-indigo-600', 'bg-amber-600');
            document.getElementById('submitBtn').classList.replace('hover:bg-indigo-700', 'hover:bg-amber-700');
            document.getElementById('cancelEditBtn').classList.remove('hidden');

            // Scroll to form
            document.getElementById('timeForm').scrollIntoView({ behavior: 'smooth' });
        };

        // Cancel Edit
        document.getElementById('cancelEditBtn').addEventListener('click', () => {
            resetForm();
        });

        function resetForm() {
            document.getElementById('timeForm').reset();
            document.getElementById('entryId').value = "";
            document.getElementById('formTitle').textContent = "New Time Block";
            document.getElementById('submitBtn').innerHTML = `
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
                <span>Add Entry</span>`;
            document.getElementById('submitBtn').classList.replace('bg-amber-600', 'bg-indigo-600');
            document.getElementById('submitBtn').classList.replace('hover:bg-amber-700', 'hover:bg-indigo-700');
            document.getElementById('cancelEditBtn').classList.add('hidden');
            document.getElementById('phiWarning').classList.add('hidden');

            // Allow date to persist or reset to today? Let's assume today for now or keep user pref.
            // But we need to ensure hidden ID is gone.
        }

        // Submit Handler (Create or Update)
        document.getElementById('timeForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const fd = new FormData(e.target);
            const entryId = fd.get('entryId');

            const data = {
                date: new Date().toISOString(), // In a real app we'd likely have a date picker field
                projectId: fd.get('projectId'),
                siteId: fd.get('siteId') || null,
                activityType: fd.get('activityType'),
                hours: parseFloat(fd.get('hours')),
                notes: fd.get('notes'),
                isWin: winToggle.checked
            };

            if (data.isWin) {
                data.winDetails = { title: fd.get('winTitle'), impact: fd.get('winImpact') };
            }

            try {
                let res;
                if (entryId) {
                    // Update
                    res = await fetch(`/api/timesheets/${entryId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });
                } else {
                    // Create
                    res = await fetch('/api/timesheets', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });
                }

                if (res.ok) {
                    resetForm();
                    // Reset win toggle visual state
                    winToggle.checked = false;
                    winFields.classList.add('hidden');
                    loadTimesheets();
                } else {
                    alert('Error saving entry');
                }
            } catch (err) {
                console.error(err);
            }
        });

        init();
    </script>
</body>

</html>